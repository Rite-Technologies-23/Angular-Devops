name: "Test and build Angular app"

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

jobs:
  build:
    name: Test and Build Angular App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install

      - name: Run Tests and Generate Reports
        run: |
          mkdir -p test-results
          npx ng test --watch=false --browsers=ChromeHeadless --karma-config=karma.conf.js || true

      - name: Convert LCOV to HTML Report
        run: |
          sudo apt-get update && sudo apt-get install -y lcov
          genhtml coverage/angular.io-example/coverage/lcov.info --output-directory test-results/lcov-html

      - name: Capture LCOV Report Content
        id: capture_lcov
        run: |
          echo "Reading lcov.info..."
          LCOV_CONTENT=$(cat coverage/angular.io-example/coverage/lcov.info | base64 | tr -d '\n')
          echo "lcov_base64=$LCOV_CONTENT" >> $GITHUB_OUTPUT

      - name: Generate Beautified LCOV Report
        run: |
          mkdir -p test-results/beautified
          LCOV_CONTENT=$(echo "${{ steps.capture_lcov.outputs.lcov_base64 }}" | base64 --decode)
          TEMPLATE_PATH="coverage-templates/beautified-lcov-template.html"
          OUTPUT_PATH="test-results/beautified/lcov-report.html"

          if [[ -f "$TEMPLATE_PATH" ]]; then
            # Replace placeholder with actual LCOV content
            sed "s|{{ LCOV_CONTENT }}|<pre>${LCOV_CONTENT}</pre>|g" "$TEMPLATE_PATH" > "$OUTPUT_PATH"
            echo "Beautified report generated at $OUTPUT_PATH"
          else
            echo "Template file not found!"
            exit 1
          fi

      - name: Check for Failed CRITICAL Tests
        run: |
          REPORT="./test-results/test-results.xml"
          echo "Parsing $REPORT for failed CRITICAL tests..."

          if [[ -f "$REPORT" ]]; then
            FAILED_CRITICAL=$(awk '/<testcase/ {test=$0} /<failure/ {if (test ~ /\[CRITICAL\]/) print test}' "$REPORT" | wc -l)
            if [[ "$FAILED_CRITICAL" -gt 0 ]]; then
              echo "$FAILED_CRITICAL CRITICAL test(s) failed."
              exit 1
            else
              echo "All CRITICAL test cases passed."
            fi
          else
            echo "Test report not found. Skipping CRITICAL test check."
          fi

      - name: Enforce Code Coverage Threshold
        run: |
          COVERAGE_FILE=coverage/angular.io-example/coverage/coverage-summary.json
          echo "Using coverage file: $COVERAGE_FILE"
          COVERAGE=$(node -p "require('./$COVERAGE_FILE').total.statements.pct")
          echo "Statements Coverage: $COVERAGE%"
          THRESHOLD=75
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Code coverage is below the required $THRESHOLD% threshold."
            exit 1
          else
            echo "Code coverage is acceptable."
          fi

      - name: Upload LCOV HTML Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: Angular-LCOV-HTML-Report
          path: test-results/lcov-html

      - name: Upload Beautified LCOV Report
        uses: actions/upload-artifact@v4
        with:
          name: Angular-Beautified-LCOV
          path: test-results/beautified/lcov-report.html

      - name: Upload JUnit XML Report
        uses: actions/upload-artifact@v4
        with:
          name: Angular-JUnit-Report
          path: test-results/test-results.xml

      - name: Upload Raw Coverage Files
        uses: actions/upload-artifact@v4
        with:
          name: Angular-Coverage-Report
          path: coverage/

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Build Angular App
        run: npm run build -- --configuration production
